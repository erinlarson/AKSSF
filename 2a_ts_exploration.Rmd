---
title: "TS exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```

# Original DFA

Tim provided DFA output on November 8, 2021. Here are comments on the files from his email:
- GlobalModelEstimates_1trend_DUE.csv contains the estimated model coefficients. It has columns Region, SiteID, Year, TempSens_Z, TempSens, TrendLoad_Z, TrendLoad
- TempSens_Z are the temperature sensitivity values in Z-score space, which come directly out of the model.
- TempSens are the temperature sensitivity values that have been back-transformed to be in units of ºC water / ºC air.
- TrendLoad_Z are the loadings on the common trend in Z-score space.
- GlobalTrendEstimates_1trend_DUE.csv contains the estimated trends by year. This has columns Year, DOY, and Trend. DOY is just Julian day of year. Trend is the trend value for that DOY.


Read in final thermal sensitivities and trend loadings from global model. Tim found that regional models did not change the results.

```{r responses}

dfa_dat <- read_csv("DFA/output_8Nov21/GlobalModelEstimates_1trend_DUE.csv")
trend_dat <- read_csv("DFA/output_8Nov21/GlobalTrends_1trend_DUE.csv")

remove_lssites <- dfa_dat %>% distinct(SiteID) %>% filter(grepl("lsr", SiteID)) 
dfa_dat <- dfa_dat %>% 
  filter(!SiteID %in% remove_lssites)

```

Plot of thermal sensitivity versus loading on common trend. Tim commented that sites with low thermal sensitivities often load strongly on the common trend, these might be groundwater sites, glacial sites, etc.

```{r ts versus trend}

dfa_dat %>% 
  ggplot(aes(TempSens, TrendLoad_Z)) +
  geom_point(aes(color = Region)) +
  facet_wrap(~Year)

```

Frequency plots of thermal sensitivities by year and region.

```{r}
dfa_dat %>% 
  ggplot(aes(TempSens)) +
  geom_freqpoly(aes(color = Region)) +
  facet_wrap(~Year)

ggsave("output/ts_region_year.jpeg", width = 9, units = "in")
```

Something strange going on in Cook Inlet in 2019, lots of site in Deshka with very low thermal sensitivities which makes no sense, these are relatively warm sites. This result does not match raw air temperature coefficients from simple lm fits.

```{r}
dfa_dat %>% 
  filter(Region == "Cook Inlet", Year == 2019, TempSens < 0.25)
```

Somethings strange going on with sites in Deshka having very low thermal sensitivities. Read in raw air-stream temperatures and plot.
Filter on time series with 70% of days from June 1 to August 31.

```{r}
dat <- readRDS("data_preparation/final_data/summer_data_wair2021-11-23.rds")

dat <- dat %>% 
  mutate(year = year(sampleDate))

jd_completeness_filter <- function(inputDat, jd_filter, completeness_filter) {
  dat <- inputDat %>% 
    mutate(jd = as.numeric(format(sampleDate, "%j")),
           year = year(sampleDate)) %>% 
    filter(jd >= 152, jd <= jd_filter) #June 1st to end date
  ndays <- max(dat$jd) - min(dat$jd)
  dat2 <- dat %>%
    group_by(SiteID, year) %>%
    mutate(completeness = n()/ndays * 100) %>% 
    filter(completeness > completeness_filter) %>% 
    ungroup()
  return(dat2)
}

dat2 <- jd_completeness_filter(dat, 243, 70)

dat %>% distinct(SiteID, year) %>% nrow()
dat2 %>% distinct(SiteID, year) %>% nrow()
```


Plot some of the deshka sites from 2019.

```{r}

dat2 %>% 
  filter(SiteID == c("Deshka 1 Downstream", "Deshka 1 Tributary"), year == 2019) %>% 
  ggplot() +
  geom_line(aes(x = sampleDate, y = meanDT)) +
  geom_line(aes(x = sampleDate, y= airDT), color = "blue") +
  facet_wrap(~SiteID)

ggsave("output/desha_air-stream_2sites.jpeg", width = 9, units = "in")
```

Plot a couple of little susitna sites. Looks much more reasonable, lower site pretty cold in June probably due to snowmelt, then tracking air temperatures pretty well later in year. Upper site very cold and not tracking air temps.

```{r}
dat %>% filter(grepl("ls", SiteID)) %>% distinct(SiteID)

dat2 %>% 
  filter(SiteID == c("lsr28.3", "lsr112"), year == 2020) %>% 
  ggplot() +
  geom_line(aes(x = sampleDate, y = meanDT)) +
  geom_line(aes(x = sampleDate, y= airDT), color = "blue") +
  facet_wrap(~SiteID)
```



Plots of common trends.

```{r}
trend_dat %>% 
  ggplot(aes(x = DOY, y = Trend)) +
  geom_line() + 
  facet_wrap(~Year)
```


# ARIMA results

Tim reran using an AR1 model (time series model with lag of 1 day) because the Deshka sites were confounding the analysis in 2017-2019. The common trend was air temperatures and the TS were super low, which is not what we want.

Read in new results, which has AR1 results linked to covariate data.

```{r}

mod_dat <- readRDS("data_preparation/final_data/model_data2022-01-14.rds")

mod_dat %>% 
  ggplot(aes(x = as.factor(Year), y = TempSens)) +
  geom_boxplot() +
  facet_wrap(~Region)

```

Pairplots for covariates versus TS.

```{r pair plots against TS}

panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y))
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}

panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "cyan", ...)
}

mod_dat %>% 
  select(TempSens, log_slope, cat_elev_MEAN, cat_slope_MEAN, 
         wtd_slope_MEAN, snow_ind, ) %>% 
  pairs(upper.panel = panel.cor, diag.panel = panel.hist)

mod_dat %>% 
  select(TempSens, log_area, dist_coast_km, wtd_north_per,
         wtd_wet_per, logit_glac, logit_lake) %>% 
  pairs(upper.panel = panel.cor, diag.panel = panel.hist)

```


Set up a leaflet mapper with a data summary that can be used as a popup.

- spatial covariates
- number of years of data
- mean TS
- range TS
- TS for 2019
- TS for a normal year


Bring in metadata which has field for Deshka sites.

```{r}
md <- read_rds("data_preparation/final_data/md.rds")

md %>% summary()

mod_dat <- left_join(mod_dat, md %>% select(SiteID, deshka, HUC8, Name), by = c("Site" = "SiteID")) 

mod_dat %>% 
  filter(deshka == 1) %>% 
  ggplot(aes(x = TempSens, y = fct_reorder(Site, TempSens), color = as.factor(Year))) +
  geom_point()
```

Read in original data frame and calculate temperature metrics so we can see how those map to thermal sensitivities.

```{r}
temp_dat <- read_rds("data_preparation/final_data/summer_data_wair2021-11-23.rds")

temp_dat %>% 
  filter(is.na(maxDT)) %>% 
  distinct(SiteID)
```



```{r}
mod_dat %>% 
  ggplot(aes(y = TempSens, x = logit_glac)) +
  geom_point(aes(color = Region))
```

```{r}
mod_dat %>% 
  ggplot(aes(x = wtd_lcld_jd, y = TempSens, color = wtd_slope_MEAN)) +
  geom_point() +
  facet_wrap(~Year)

mod_dat %>% 
  ggplot(aes(x = snow_ind, y = TempSens, color = wtd_slope_MEAN)) +
  geom_point()


```

