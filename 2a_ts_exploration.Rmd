---
title: "TS exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
```


Read in final thermal sensitivities and trend loadings from global model. Tim found that regional models did not change the results.

```{r responses}

ts_dat <- read_csv("DFA/output_8Nov21/GlobalModelEstimates_1trend_DUE.csv")
trend_dat <- read_csv("DFA/output_8Nov21/GlobalTrends_1trend_DUE.csv")

remove_lssites <- ts_dat %>% distinct(SiteID) %>% filter(grepl("lsr", SiteID)) 
ts_dat <- ts_dat %>% 
  filter(!SiteID %in% remove_lssites)

```



Plot of thermal sensitivity versus loading on common trend. Tim commented that sites with low thermal sensitivities often load strongly on the common trend, these might be groundwater sites, glacial sites, etc.

```{r ts versus trend}

ts_dat %>% 
  ggplot(aes(TempSens, TrendLoad_Z)) +
  geom_point(aes(color = Region)) +
  facet_wrap(~Year)

```

Frequency plots of thermal sensitivities by year and region.

```{r}
ts_dat %>% 
  ggplot(aes(TempSens)) +
  geom_freqpoly(aes(color = Region)) +
  facet_wrap(~Year)

ggsave("output/ts_region_year.jpeg", width = 9, units = "in")
```

Something strange going on in Cook Inlet in 2019, lots of site in Deshka with very low thermal sensitivities which makes no sense, these are relatively warm sites. This result does not match raw air temperature coefficients from simple lm fits.

```{r}
ts_dat %>% 
  filter(Region == "Cook Inlet", Year == 2019, TempSens < 0.25)
```

Somethings strange going on with sites in Deshka having very low thermal sensitivities. Read in raw air-stream temperatures and plot.
Filter on time series with 70% of days from June 1 to August 31.

```{r}
dat <- readRDS("data_preparation/final_data/summer_data_wair2021-07-30.rds")

dat <- dat %>% 
  mutate(year = year(sampleDate))

jd_completeness_filter <- function(inputDat, jd_filter, completeness_filter) {
  dat <- inputDat %>% 
    mutate(jd = as.numeric(format(sampleDate, "%j")),
           year = year(sampleDate)) %>% 
    filter(jd >= 152, jd <= jd_filter) #June 1st to end date
  ndays <- max(dat$jd) - min(dat$jd)
  dat2 <- dat %>%
    group_by(SiteID, year) %>%
    mutate(completeness = n()/ndays * 100) %>% 
    filter(completeness > completeness_filter) %>% 
    ungroup()
  return(dat2)
}

dat2 <- jd_completeness_filter(dat, 243, 70)

dat %>% distinct(SiteID, year) %>% nrow()
dat2 %>% distinct(SiteID, year) %>% nrow()
```


Plot some of the deshka sites from 2019.

```{r}

dat2 %>% 
  filter(SiteID == c("Deshka 1 Downstream", "Deshka 1 Tributary"), year == 2019) %>% 
  ggplot() +
  geom_line(aes(x = sampleDate, y = meanDT)) +
  geom_line(aes(x = sampleDate, y= airDT), color = "blue") +
  facet_wrap(~SiteID)

ggsave("output/desha_air-stream_2sites.jpeg", width = 9, units = "in")
```


Plots of common trends.

```{r}
trend_dat %>% 
  ggplot(aes(x = DOY, y = Trend)) +
  geom_line() + 
  facet_wrap(~Year)
```



