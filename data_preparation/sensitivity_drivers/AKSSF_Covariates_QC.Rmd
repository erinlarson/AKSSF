---
title: "ACCS-UAA Covariate qc and data exploration"
output:
  html_document: 
    df_print: paged
    fig_width: 20
    fig_height: 10
    fig_caption: yes
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
      smooth_scroll: false
geometry: margin = 0.1in
editor_options: 
  chunk_output_type: inline
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

Document last updated `r Sys.time()` by Dustin Merrigan (dwmerrigan@alaska.edu)

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

##
Replace all nan with 0

```{r Packages, message=FALSE, warning=FALSE}

# clear environment
rm(list=ls())
library(pacman)
p_load(DataExplorer,tidyverse,lubridate,readr,readxl,hms,plotly,DT,stringr,
       janitor,ggplot2)
```

<br> 
# Read In Datasets
Examine datasets AKSSF_Covariates.csv and AKSSF_sites_sj_maxfac.csv using 
descriptive statistics, plots,  and in maps where appropriate.


```{r AKSSF datasets}
getwd()
#Data from covariates script
cov.df.raw <- read.csv(file = 'AKSSF_Covariates.csv', header = TRUE) 
#Data from spatial join script
sites.df <- read.csv(file = 'AKSSF_sites_sj_maxfac.csv', header = TRUE)
#Data from Modis Script
lcld.df <- read.csv(file = 'AKSSF_wtd_lcld_mn.csv', header = TRUE)
lcld_cols <-  c("wtd_lcld_mn_2001","wtd_lcld_mn_2002", "wtd_lcld_mn_2003",
                "wtd_lcld_mn_2004","wtd_lcld_mn_2005", "wtd_lcld_mn_2006",
                "wtd_lcld_mn_2007", "wtd_lcld_mn_2008", "wtd_lcld_mn_2009",
                "wtd_lcld_mn_2010", "wtd_lcld_mn_2011", "wtd_lcld_mn_2012",
                "wtd_lcld_mn_2013","wtd_lcld_mn_2014", "wtd_lcld_mn_2015",
                "wtd_lcld_mn_2016", "wtd_lcld_mn_2017", "wtd_lcld_mn_2018",
                "wtd_lcld_mn_2019")

dput(colnames(sites.df))

site_keep_cols <- c("SiteID","region", "cat_ID_con", "site_max_acc", "site_acc_sqKm",
                    "Area_km2","area_diff","size_diff", "lat", "lon",
                    'str_ord','str_slope',"dist_coast_km","ds_dist_outlet")

sites.df <- sites.df %>% 
  mutate( region = sub("_$","",gsub('[[:digit:]"]+', '', cat_ID_con)),
  size_diff =  case_when(area_diff >0~'Larger', area_diff <0~'Smaller',
                        TRUE~'No Change')) %>% 
  subset(select = site_keep_cols )
  
dput(colnames(cov.df.raw))

wtd_keep_cols <- c("cat_ID_con","cat_ID","region", "cat_slope_MIN", "cat_slope_MAX",
  "cat_slope_MEAN", "cat_slope_STD", "cat_slope_SUM", "cat_elev_MIN", 
  "cat_elev_MAX", "cat_elev_MEAN", "cat_elev_STD", "wtd_elev_MIN",
  "wtd_elev_MAX", "wtd_elev_MEAN", "wtd_elev_STD", "wtd_slope_MIN",
  "wtd_slope_MAX", "wtd_slope_MEAN", "wtd_slope_STD", "wtd_north_per", 
  "wtd_wet_per","wtd_lake_per","wtd_glacier_per","wtd_area_sqKM")


cov.df <- cov.df.raw %>%
  mutate(wtd_area_sqKM = wtd_elev_AREA *1e-6) %>% 
  subset(select = wtd_keep_cols )

# Convert na to 0
cov.df[is.na(cov.df)] <- 0


```

## Site Accumulation Area vs Wtd Area
Compare watershed area (area_km2) as calcuated from shape area in GIS to area
calculated from the max flow accumulation () for a given site.  Flow accumulation
was extracted using zonal statistics as table on a 30 meter site buffer 
(clipped to catchment) on the appropriate flow accumulation grid, TauDEM derived
or NHDPlus depending on region being analyzed.

Definitely some outliers that need to be Identified and examined in GIS

```{r Linear Regression onflow acc area and watershed area}

#Function to plot data

ggplotRegression <- function (fit) {

require(ggplot2)

ggplot(fit$model, aes_string(x = names(fit$model)[2], y = names(fit$model)[1])) + 
  geom_point() +
  stat_smooth(method = "lm", col = "red") +
  labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                     "Intercept =",signif(fit$coef[[1]],5 ),
                     " Slope =",signif(fit$coef[[2]], 5),
                     " P =",signif(summary(fit)$coef[2,4], 5)))
}

site_flow_regr <-ggplotRegression(lm(Area_km2 ~site_acc_sqKm, data = sites.df))
site_flow_regr

```
```{r Interactive Plot}
areafig <- plot_ly(
  sites.df, y = ~Area_km2 ,x =~site_acc_sqKm,
  #Hover Text
  text = ~paste("SiteID:", SiteID,'<br>AreaDiff:', area_diff),
  color = ~region, size = ~area_diff, symbol = ~size_diff
)

areafig
```


## DataExplorer Report for dataset
```{r Data Explore dfs, message=FALSE, warning=FALSE}

#use DataExplorer  package to examine data
create_report(cov.df, output_file = "AKSSF_Covariate_DataExplore.html")

create_report(sites.df, output_format = html_document(),output_file = "AKSSF_Sites_DataExplore.html")
#use DataExplorer  package to examine data

# Could also loop through regions and spit out regional reports
regions <-  c("Kodiak", "Copper_River", "Prince_William_Sound", "Cook_Inlet", "Bristol_Bay")
for (r in regions){
  print(r)
  df <-  cov.df %>%
    filter(region == r)
  name <- paste(r,'_DataExplore.html', sep = "", collapse = "")
  create_report(df, output_format = html_document(),output_file = name)
  print (name)
}
  
```

## Data by region
```{r Data Explore QQ plots by region}
dat_cols <- c("region", "cat_slope_MIN", "cat_slope_MAX",
"cat_slope_MEAN", "cat_slope_STD", "cat_slope_SUM", "cat_elev_MIN", 
"cat_elev_MAX", "cat_elev_MEAN", "cat_elev_STD", "wtd_elev_MIN",
"wtd_elev_MAX", "wtd_elev_MEAN", "wtd_elev_STD", "wtd_slope_MIN",
"wtd_slope_MAX", "wtd_slope_MEAN", "wtd_slope_STD", "wtd_north_per", 
"wtd_wet_per","wtd_lake_per","wtd_glacier_per","wtd_area_sqKM")

cov.df.explore <- cov.df[,dat_cols]
plot_qq(cov.df.explore, by = "region")
```
### Bristol Bay
```{r Bbay Missing}
reg = 'Bristol_Bay'
bb_miss <- cov.df.explore %>% 
  filter(region == reg) %>% 
  plot_missing()

```

```{r Bbay Histo}
bb_histo <- cov.df.explore %>% 
  filter(region == reg) %>% 
  plot_histogram()


```

```{r Bbay QQplot}
bb_qq <- cov.df.explore %>% 
  filter(region == reg) %>% 
  plot_qq()

```
```{r Bbay correlation}
bb_co <- cov.df.explore %>% 
  filter(region == reg)
plot_correlation(na.omit(bb_co))

```
### Kodiak
```{r Kod Missing}
reg1 = 'Kodiak'
ko_miss <- cov.df.explore %>% 
  filter(region == reg1) %>% 
  plot_missing()

```

```{r Kod Histo}
ko_histo <- cov.df.explore %>% 
  filter(region == reg1) %>% 
  plot_histogram()


```

```{r Kod QQplot}
ko_qq <- cov.df.explore %>% 
  filter(region == reg1) %>% 
  plot_qq()

```

```{r Kod correlation}
ko_co <- cov.df.explore %>% 
  filter(region == reg1)

plot_correlation(na.omit(ko_co))
```

### PWS
```{r PWS Missing}
reg2 = 'Prince_William_Sound'
pws_miss <- cov.df.explore %>% 
  filter(region == reg2) %>% 
  plot_missing()

```

```{r PWS Histo}
pws_histo <- cov.df.explore %>% 
  filter(region == reg2) %>% 
  plot_histogram()


```

```{r PWS QQplot}
pws_qq <- cov.df.explore %>% 
  filter(region == reg2) %>% 
  plot_qq()

```

```{r PWS correlation}
pws_co <- cov.df.explore %>% 
  filter(region == reg2)

plot_correlation(na.omit(pws_co))
```
### Cook Inlet
```{r Cook Inlet Missing}
reg3 = 'Cook_Inlet'
ci_miss <- cov.df.explore %>% 
  filter(region == reg3) %>% 
  plot_missing()

```

```{r Cook Inlet Histo}
ci_histo <- cov.df.explore %>% 
  filter(region == reg3) %>% 
  plot_histogram()


```

```{r Cook Inlet QQplot}
ci_qq <- cov.df.explore %>% 
  filter(region == reg3) %>% 
  plot_qq()

```

```{r Cook Inlet correlation}
ci_co <- cov.df.explore %>% 
  filter(region == reg3)

plot_correlation(na.omit(ci_co))
```

### Copper River
```{r Copper River Missing}
reg4 = 'Copper_River'
co_miss <- cov.df.explore %>% 
  filter(region == reg4) %>% 
  plot_missing()

```

```{r Copper River Histo}
co_histo <- cov.df.explore %>% 
  filter(region == reg4) %>% 
  plot_histogram()


```

```{r Copper River QQplot}
co_qq <- cov.df.explore %>% 
  filter(region == reg4) %>% 
  plot_qq()

```

```{r Copper River correlation}
co_co <- cov.df.explore %>% 
  filter(region == reg4)

plot_correlation(na.omit(co_co))
```
