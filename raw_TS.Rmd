---
title: "raw_TS"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(broom)
library(lubridate)
library(purrr)
```


# Thermal sensitivity and Accumulated Degree Days predictor

Raw thermal sensitivity from linear regressions and test of ADD to better predict daily stream temperatures affected by groundwater (Snyder et. al. 2015).

```{r}
dat <- readRDS("data_preparation/final_data/summer_data_wair2021-11-23.rds")

dat <- dat %>% 
  mutate(year = year(sampleDate))
```

Filter on time series with 80% of days from June 1 to August 31.

```{r}
jd_completeness_filter <- function(inputDat, jd_filter, completeness_filter) {
  dat <- inputDat %>% 
    mutate(jd = as.numeric(format(sampleDate, "%j")),
           year = year(sampleDate)) %>% 
    filter(jd >= 152, jd <= jd_filter) #June 1st to end date
  ndays <- max(dat$jd) - min(dat$jd)
  dat2 <- dat %>%
    group_by(SiteID, year) %>%
    mutate(completeness = n()/ndays * 100) %>% 
    filter(completeness > completeness_filter) %>% 
    ungroup()
  return(dat2)
}

dat2 <- jd_completeness_filter(dat, 243, 80)

dat %>% distinct(SiteID, year) %>% nrow()
dat2 %>% distinct(SiteID, year) %>% nrow()
```

Add in a mean summer air temperature and the accumulated degree-days above mean summer air temperatures.

```{r}
dat2 <- dat2 %>% 
  filter(month(sampleDate) %in% 6:8) %>% 
  group_by(SiteID, year) %>% 
  mutate(meanSumAT = mean(airDT),
         st_gt_at = case_when(meanDT > meanSumAT ~ meanDT,
                           meanDT < meanSumAT ~ 0),
         cumST = cumsum(st_gt_at))
  
```

Create lm fits using model with just air temperature and model with air temperature and accumulated degree days above mean summer air temperature.

```{r}
nested <- dat2 %>% 
  ungroup() %>% 
  nest(data = -SiteID, -year)

lm.fits <- nested %>% 
  mutate(fit1 = map(data, ~lm(meanDT ~ airDT, data = .x)),
         fit2 = map(data, ~lm(meanDT ~ airDT + cumST, data = .x)),
         tidied1 = map(fit1, tidy),
         glanced1 = map(fit1, glance),
         augmented1 = map(fit1, augment),
         tidied2 = map(fit2, tidy),
         glanced2 = map(fit2, glance),
         augmented2 = map(fit2, augment)) 

```


1. Does model fit improve with the cumulative stream temperature term? Not much at all.


```{r}
glance1 <- lm.fits %>% 
            unnest(glanced1)
glance2 <- lm.fits %>% 
            unnest(glanced2)

left_join(glance1 %>% select(SiteID, year, fit1 = adj.r.squared),
          glance2 %>% select(SiteID, year, fit2 = adj.r.squared)) %>%
  pivot_longer(names_to = "fit", values_to = 'r2', cols = fit1:fit2) %>% 
  ggplot() +
  geom_boxplot(aes(x = fit, y = r2))

```

2. Does change in adjusted r2 relate to slope?

```{r}
tidy1 <- lm.fits %>% 
  unnest(tidied1)

r2diff <- left_join(glance1 %>% select(SiteID, year, fit1 = adj.r.squared),
          glance2 %>% select(SiteID, year, fit2 = adj.r.squared)) %>% 
  mutate(diff = fit2-fit1)

left_join(tidy1 %>% filter(term == "airDT") %>% select(SiteID, year, estimate),
          r2diff) %>% 
  ggplot() +
  geom_point(aes(x = estimate, y = diff))

#check for any sites with negative slopes (to compare to AR1 fits in report 2b)
tidy1 %>% 
  filter(term == "airDT", estimate < 0.1) %>% 
  distinct(SiteID)
```

3. Is there a negative relationship between intercepts and slopes?

```{r}
tidy1 %>% 
  select(term, estimate) %>% 
  pivot_wider(names_from = term, values_from = estimate) %>%
  rename(int = `(Intercept)`) %>% 
  ggplot() +
  geom_point(aes(y = int, x = airDT))
```



Check on some of these TS results, why are some greater than 1? I was hoping that was a relic issue related to air temperatures from airports along the coast and wouldn't happen again with gridded data. Looks like some lake sites.

```{r}
tidy1 %>% 
  filter(term == "airDT", estimate > 1) %>% 
  arrange(desc(estimate))

tidy1 %>% 
  filter(term == "(Intercept)") %>% 
  arrange(estimate)
```


```{r}
dat2 %>% 
  filter(SiteID == "USFS_Cabin Lake Outlet", year == 2012) %>% 
  ggplot() +
  geom_line(aes(x = sampleDate, y = meanDT)) +
  geom_line(aes(x = sampleDate, y= airDT), color = "blue")
```


Very low thermal sensitivities in 2019 in Cook Inlet, seems to be associated with Deshka network because large shift to left in freq poly in 2017, what is going on? The lm fits do NOT show the same pattern as the thermal sensitivities from dfa, no deshka sites at all in this filter.

```{r}
tidy1 %>% 
  filter(term == "airDT", estimate < 0.25, year == 2019) %>% 
  arrange(desc(estimate))


tidy1 %>% 
  filter(grepl("Deshka|Moose|Kroto", SiteID), term == "airDT", year == 2019) %>% 
  arrange(desc(estimate))

```





# Weekly Thermal sensitivity 

Weekly stream thermal sensitivity from linear regressions.

```{r}
dat <- readRDS("data_preparation/final_data/summer_data_wair2021-11-23.rds")

dat <- dat %>% 
  mutate(year = year(sampleDate))
```

Filter on time series with 80% of days from June 1 to August 31.

```{r}
jd_completeness_filter <- function(inputDat, jd_filter, completeness_filter) {
  dat <- inputDat %>% 
    mutate(jd = as.numeric(format(sampleDate, "%j")),
           year = year(sampleDate)) %>% 
    filter(jd >= 152, jd <= jd_filter) #June 1st to end date
  ndays <- max(dat$jd) - min(dat$jd)
  dat2 <- dat %>%
    group_by(SiteID, year) %>%
    mutate(completeness = n()/ndays * 100) %>% 
    filter(completeness > completeness_filter) %>% 
    ungroup()
  return(dat2)
}

dat2 <- jd_completeness_filter(dat, 243, 80)

dat %>% distinct(SiteID, year) %>% nrow()
dat2 %>% distinct(SiteID, year) %>% nrow()
```

Create lm fits using model with just air temperature and model with air temperature squared. Possibility that there are non-linearities at warmest temps, but no temps near to 0 in summer.

```{r}

weekly_dat <- dat2 %>% 
  mutate(week = format(sampleDate, "%W")) %>% 
  group_by(SiteID, year, week) %>% 
  mutate(week_ct = n()) %>% 
  filter(week_ct >= 4) %>% 
  summarize(meanDT_wk = mean(meanDT),
            airDT_wk = mean(airDT))

nested <- weekly_dat %>% 
  select(SiteID, year, meanDT_wk, airDT_wk) %>% 
  ungroup() %>% 
  nest(data = c(meanDT_wk, airDT_wk))

lm.fits <- nested %>% 
  mutate(fit1 = map(data, ~lm(meanDT_wk ~ airDT_wk, data = .x)),
         fit2 = map(data, ~lm(meanDT_wk ~ I(airDT_wk^2), data = .x)),
         tidied1 = map(fit1, tidy),
         glanced1 = map(fit1, glance),
         augmented1 = map(fit1, augment),
         tidied2 = map(fit2, tidy),
         glanced2 = map(fit2, glance),
         augmented2 = map(fit2, augment)) 

```


1. Does model fit improve with the squared stream temperature term? Not much at all.


```{r}
glance1 <- lm.fits %>% 
            unnest(glanced1)
glance2 <- lm.fits %>% 
            unnest(glanced2)

left_join(glance1 %>% select(SiteID, year, fit1 = adj.r.squared),
          glance2 %>% select(SiteID, year, fit2 = adj.r.squared)) #%>%
  mutate(diff = fit1 - fit2) %>% 
  ggplot() +
  geom_histogram(aes(x = diff))

```

3. Is there a negative relationship between intercepts and slopes?

```{r}
tidy1 <- lm.fits %>% 
  unnest(tidied1)

#check for any sites with negative slopes (to compare to AR1 fits in report 2b)
tidy1 %>% 
  filter(term == "airDT_wk", estimate < 0.1) %>% 
  distinct(SiteID)

tidy1 %>% 
  select(SiteID, year, term, estimate) %>% 
  pivot_wider(names_from = term, values_from = estimate) %>%
  rename(int = `(Intercept)`) %>% 
  ggplot() +
  geom_point(aes(y = int, x = airDT_wk))
```



Check on some of these TS results, why are some greater than 1? I was hoping that was a relic issue related to air temperatures from airports along the coast and wouldn't happen again with gridded data. Looks like some lake sites.

```{r}
tidy1 %>% 
  filter(term == "airDT_wk", estimate > 1) %>% 
  arrange(desc(estimate))

tidy1 %>% 
  filter(term == "(Intercept)") %>% 
  arrange(estimate)
```


```{r}
dat2 %>% 
  filter(SiteID == "USFS_Cabin Lake Outlet", year == 2012) %>% 
  ggplot() +
  geom_line(aes(x = sampleDate, y = meanDT)) +
  geom_line(aes(x = sampleDate, y= airDT), color = "blue")
```


Very low thermal sensitivities in 2019 in Cook Inlet, seems to be associated with Deshka network because large shift to left in freq poly in 2017, what is going on? The lm fits do NOT show the same pattern as the thermal sensitivities from dfa, no deshka sites at all in this filter.

```{r}
tidy1 %>% 
  filter(term == "airDT", estimate < 0.25, year == 2019) %>% 
  arrange(desc(estimate))


tidy1 %>% 
  filter(grepl("Deshka|Moose|Kroto", SiteID), term == "airDT", year == 2019) %>% 
  arrange(desc(estimate))

```

What do Cook Inlet sites look like?

```{r}

tidy1 %>% 
  filter(SiteID %in% c("CIK_14", "CIK_3", "CIK_30", "CIK_35", "CIK_38", "CIK_4", "CIK_6", "CIK_8"), term == "airDT_wk")  %>% 
  group_by(SiteID) %>% 
   mutate(ts_sc = scale(estimate)) %>% 
  ggplot(aes(x = year, y = ts_sc, color = SiteID)) +
  geom_line() +
  geom_point() +
  geom_hline(aes(yintercept = 0)) +
  scale_x_continuous(breaks = c(seq(2000, 2019, 2))) 
  

```


